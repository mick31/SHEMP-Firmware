/*
 * temperature_sensor.c
 *
 *  Created on: Jul 25, 2012
 *      Author: nabercro
 */

#include "temperature_sensor.h"





#define TEMP_OFFSET 567
#define TEMP_CAP 1801

const uint16_t temp_lookup_table[] = {
		/*65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,
		62935,59825,56973,54351,51931,49694,47620,45692,43896,42220,40653,39184,37806,36509,35289,34138,33051,32023,31049,30126,29250,28417,27625,26870,26151,
		25465,24809,24183,23583,23009,22459,21931,21425,20939,20471,20022,19589,19173,18772,18385,18012,17652,17304,16968,16643,16329,16025,15731,15446,15170,
		14903,14644,14392,14148,13911,13681,13457,13240,13029,12823,12623,12429,12240,12055,11876,11701,11530,11364,11202,11044,10890,10739,10592,10449,10309,
		10172,10038,9907,9780,9655,9533,9413,9296,9182,9070,8961,8853,8748,8645,8545,8446,8349,8254,8161,8070,7980,7893,7807,7722,7639,7558,7478,7400,7323,7247,
		7173,7100,7029,6958,6889,6821,6754,6689,6624,6561,6498,6437,6377,6317,6259,6201,6145,6089,6034,5980,5927,5875,5823,5773,5723,5673,5625,5577,5530,5484,
		5438,5393,5349,5305,5262,5219,5177,5136,5095,5055,5015,4976,4938,4899,4862,4825,4788,4752,4717,4681,4647,4612,4579,4545,4512,4480,4448,4416,4384,4353,
		4323,4293,4263,4233,4204,4175,4147,4119,4091,4064,4037,4010,3983,3957,3931,3906,3880,3855,3830,3806,3782,3758,3734,3711,3688,3665,3642,3620,3597,3575,
		3554,3532,3511,3490,3469,3449,3428,3408,3388,3368,3349,3329,3310,3291,3272,3254,3235,3217,3199,3181,3163,3146,3128,3111,3094,3077,3061,3044,3028,3011,
		2995,2979,2964,2948,2932,2917,2902,2887,2872,2857,2842,2828,2813,2799,2785,2771,2757,2743,2729,2716,2702,2689,2676,2663,2650,2637,2624,2611,2599,2586,
		2574,2562,2550,2537,2526,2514,2502,2490,2479,2467,2456,2445,2433,2422,2411,2400,2389,2379,2368,2357,2347,2336,2326,2316,2306,2296,2285,2276,2266,2256,
		2246,2236,2227,2217,2208,2198,2189,2180,2171,2162,2153,2144,2135,2126,2117,2108,2100,2091,2083,2074,2066,2057,2049,2041,2033,2025,2016,2008,2001,1993,
		1985,1977,1969,1962,1954,1946,1939,1931,1924,1917,1909,1902,1895,1888,1880,1873,1866,1859,1852,1845,1839,1832,1825,1818,1812,1805,1798,1792,1785,1779,
		1772,1766,1760,1753,1747,1741,1735,1728,1722,1716,1710,1704,1698,1692,1686,1680,1675,1669,1663,1657,1652,1646,1640,1635,1629,1624,1618,1613,1607,1602,
		1597,1591,1586,1581,1575,1570,1565,1560,1555,1550,1545,1540,1535,1530,1525,1520,1515,1510,1505,1500,1496,1491,1486,1481,1477,1472,1467,1463,1458,1454,
		1449,1445,1440,1436,1431,1427,1422,1418,1414,1409,1405,1401,1397,1392,1388,1384,1380,1376,1372,1368,1363,1359,1355,1351,1347,1343,1339,1336,1332,1328,
		1324,1320,1316,1312,1309,1305,1301,1297,1294,1290,1286,1283,1279,1275,1272,1268,1265,1261,1258,1254,1250,1247,1244,1240,1237,1233,1230,1226,1223,1220,
		1216,1213,1210,1207,1203,1200,1197,1194,1190,1187,1184,1181,1178,1174,1171,1168,1165,1162,1159,1156,1153,1150,1147,1144,1141,1138,1135,1132,1129,1126,
		1123,1120,1118,1115,1112,1109,1106,1103,1101,1098,1095,1092,1089,1087,1084,1081,1079,1076,1073,1071,1068,1065,1063,1060,1057,1055,1052,1050,1047,1044,
		1042,1039,1037,1034,1032,1029,1027,1024,1022,1020,1017,1015,1012,1010,1007,1005,1003,*/1000,998,996,993,991,989,986,984,982,979,977,975,973,970,968,966,
		964,961,959,957,955,953,950,948,946,944,942,940,938,936,933,931,929,927,925,923,921,919,917,915,913,911,909,907,905,903,901,899,897,895,893,891,889,887,
		885,884,882,880,878,876,874,872,870,868,867,865,863,861,859,858,856,854,852,850,849,847,845,843,842,840,838,836,835,833,831,829,828,826,824,823,821,819,
		818,816,814,813,811,809,808,806,805,803,801,800,798,796,795,793,792,790,789,787,785,784,782,781,779,778,776,775,773,772,770,769,767,766,764,763,761,760,
		758,757,756,754,753,751,750,748,747,745,744,743,741,740,738,737,736,734,733,732,730,729,727,726,725,723,722,721,719,718,717,715,714,713,711,710,709,708,
		706,705,704,702,701,700,699,697,696,695,694,692,691,690,689,687,686,685,684,683,681,680,679,678,677,675,674,673,672,671,669,668,667,666,665,664,662,661,
/**/		660,659,658,657,656,654,653,652,651,650,649,648,647,646,644,643,642,641,640,639,638,637,636,635,634,633,631,630,629,628,627,626,625,624,623,622,621,620,
		619,618,617,616,615,614,613,612,611,610,609,608,607,606,605,604,603,602,601,600,599,598,597,596,595,594,593,592,591,590,590,589,588,587,586,585,584,583,
		582,581,580,579,578,578,577,576,575,574,573,572,571,570,569,569,568,567,566,565,564,563,562,562,561,560,559,558,557,556,556,555,554,553,552,551,551,550,
		549,548,547,546,546,545,544,543,542,542,541,540,539,538,537,537,536,535,534,534,533,532,531,530,530,529,528,527,526,526,525,524,523,523,522,521,520,520,
		519,518,517,517,516,515,514,514,513,512,511,511,510,509,509,508,507,506,506,505,504,503,503,502,501,501,500,499,499,498,497,496,496,495,494,494,493,492,
		492,491,490,490,489,488,487,487,486,485,485,484,483,483,482,481,481,480,480,479,478,478,477,476,476,475,474,474,473,472,472,471,470,470,469,469,468,467,
		467,466,465,465,464,464,463,462,462,461,461,460,459,459,458,457,457,456,456,455,454,454,453,453,452,452,451,450,450,449,449,448,447,447,446,446,445,445,
		444,443,443,442,442,441,441,440,439,439,438,438,437,437,436,435,435,434,434,433,433,432,432,431,431,430,429,429,428,428,427,427,426,426,425,425,424,424,
		423,423,422,421,421,420,420,419,419,418,418,417,417,416,416,415,415,414,414,413,413,412,412,411,411,410,410,409,409,408,408,407,407,406,406,405,405,404,
		404,403,403,402,402,401,401,400,400,399,399,399,398,398,397,397,396,396,395,395,394,394,393,393,392,392,392,391,391,390,390,389,389,388,388,387,387,387,
/**/		386,386,385,385,384,384,383,383,383,382,382,381,381,380,380,379,379,379,378,378,377,377,376,376,376,375,375,374,374,373,373,373,372,372,371,371,370,370,
		370,369,369,368,368,368,367,367,366,366,366,365,365,364,364,363,363,363,362,362,361,361,361,360,360,359,359,359,358,358,357,357,357,356,356,356,355,355,
		354,354,354,353,353,352,352,352,351,351,351,350,350,349,349,349,348,348,348,347,347,346,346,346,345,345,345,344,344,343,343,343,342,342,342,341,341,341,
		340,340,339,339,339,338,338,338,337,337,337,336,336,336,335,335,335,334,334,333,333,333,332,332,332,331,331,331,330,330,330,329,329,329,328,328,328,327,
		327,327,326,326,326,325,325,325,324,324,324,323,323,323,322,322,322,321,321,321,320,320,320,319,319,319,318,318,318,317,317,317,317,316,316,316,315,315,
		315,314,314,314,313,313,313,312,312,312,311,311,311,311,310,310,310,309,309,309,308,308,308,308,307,307,307,306,306,306,305,305,305,305,304,304,304,303,
		303,303,302,302,302,302,301,301,301,300,300,300,300,299,299,299,298,298,298,298,297,297,297,296,296,296,296,295,295,295,294,294,294,294,293,293,293,292,
		292,292,292,291,291,291,291,290,290,290,289,289,289,289,288,288,288,288,287,287,287,286,286,286,286,285,285,285,285,284,284,284,284,283,283,283,283,282,
		282,282,282,281,281,281,280,280,280,280,279,279,279,279,278,278,278,278,277,277,277,277,276,276,276,276,275,275,275,275,274,274,274,274,273,273,273,273,
		272,272,272,272,271,271,271,271,270,270,270,270,270,269,269,269,269,268,268,268,268,267,267,267,267,266,266,266,266,266,265,265,265,265,264,264,264,264,
		263,263,263,263,262,262,262,262,262,261,261,261,261,260,260,260,260,260,259,259,259,259,258,258,258,258,258,257,257,257,257,256,256,256,256,256,255,255,
		255,255,254,254,254,254,254,253,253,253,253,253,252,252,252,252,251,251,251,251,251,250,250,250,250,250,249,249,249,249,249,248,248,248,248,247,247,247,
		247,247,246,246,246,246,246,245,245,245,245,245,244,244,244,244,244,243,243,243,243,243,242,242,242,242,242,241,241,241,241,241,240,240,240,240,240,239,
		239,239,239,239,238,238,238,238,238,237,237,237,237,237,237,236,236,236,236,236,235,235,235,235,235,234,234,234,234,234,234,233,233,233,233,233,232,232,
/**/		232,232,232,231,231,231,231,231,231,230,230,230,230,230,229,229,229,229,229,229,228,228,228,228,228,227,227,227,227,227,227,226,226,226,226,226,226,225,
		225,225,225,225,224,224,224,224,224,224,223,223,223,223,223,223,222,222,222,222,222,222,221,221,221,221,221,221,220,220,220,220,220,220,219,219,219,219,
		219,219,218,218,218,218,218,218,217,217,217,217,217,217,216,216,216,216,216,216,215,215,215,215,215,215,214,214,214,214,214,214,213,213,213,213,213,213,
		213,212,212,212,212,212,212,211,211,211,211,211,211,210,210,210,210,210,210,210,209,209,209,209,209,209,208,208,208,208,208,208,208,207,207,207,207,207,
		207,206,206,206,206,206,206,206,205,205,205,205,205,205,205,204,204,204,204,204,204,203,203,203,203,203,203,203,202,202,202,202,202,202,202,201,201,201,
		201,201,201,201,200,200,200,200,200,200,200,199,199,199,199,199,199,199,198,198,198,198,198,198,198,197,197,197,197,197,197,197,197,196,196,196,196,196,
		196,196,195,195,195,195,195,195,195,194,194,194,194,194,194,194,194,193,193,193,193,193,193,193,192,192,192,192,192,192,192,192,191,191,191,191,191,191,
		191,190,190,190,190,190,190,190,190,189,189,189,189,189,189,189,189,188,188,188,188,188,188,188,187,187,187,187,187,187,187,187,186,186,186,186,186,186,
/**/		186,186,185,185,185,185,185,185,185,185,184,184,184,184,184,184,184,184,183,183,183,183,183,183,183,183,183,182,182,182,182,182,182,182,182,181,181,181,
		181,181,181,181,181,180,180,180,180,180,180,180,180,180,179,179,179,179,179,179,179,179,178,178,178,178,178,178,178,178,178,177,177,177,177,177,177,177,
		177,176,176,176,176,176,176,176,176,176,175,175,175,175,175,175,175,175,175,174,174,174,174,174,174,174,174,174,173,173,173,173,173,173,173,173,173,172,
		172,172,172,172,172,172,172,172,171,171,171,171,171,171,171,171,171,170,170,170,170,170,170,170,170,170,170,169,169,169,169,169,169,169,169,169,168,168,
		168,168,168,168,168,168,168,167,167,167,167,167,167,167,167,167,167,166,166,166,166,166,166,166,166,166,166,165,165,165,165,165,165,165,165,165,165,164,
		164,164,164,164,164,164,164,164,164,163,163,163,163,163,163,163,163,163,163,162,162,162,162,162,162,162,162,162,162,161,161,161,161,161,161,161,161,161,
		161,160,160,160,160,160,160,160,160,160,160,159,159,159,159,159,159,159,159,159,159,159,158,158,158,158,158,158,158,158,158,158,157,157,157,157,157,157,
		157,157,157,157,157,156,156,156,156,156,156,156,156,156,156,156,155,155,155,155,155,155,155,155,155,155,155,154,154,154,154,154,154,154,154,154,154,154,
		153,153,153,153,153,153,153,153,153,153,153,152,152,152,152,152,152,152,152,152,152,152,151,151,151,151,151,151,151,151,151,151,151,151,150,150,150,150,
		150,150,150,150,150,150,150,149,149,149,149,149,149,149,149,149,149,149,149,148,148,148,148,148,148,148,148,148,148,148,148,147,147,147,147,147,147,147,
/*		147,147,147,147,147,146,146,146,146,146,146,146,146,146,146,146,146,145,145,145,145,145,145,145,145,145,145,145,145,144,144,144,144,144,144,144,144,144,
		144,144,144,144,143,143,143,143,143,143,143,143,143,143,143,143,142,142,142,142,142,142,142,142,142,142,142,142,142,141,141,141,141,141,141,141,141,141,
		141,141,141,141,140,140,140,140,140,140,140,140,140,140,140,140,140,139,139,139,139,139,139,139,139,139,139,139,139,139,138,138,138,138,138,138,138,138,
		138,138,138,138,138,138,137,137,137,137,137,137,137,137,137,137,137,137,137,136,136,136,136,136,136,136,136,136,136,136,136,136,136,135,135,135,135,135,
		135,135,135,135,135,135,135,135,135,134,134,134,134,134,134,134,134,134,134,134,134,134,134,133,133,133,133,133,133,133,133,133,133,133,133,133,133,132,
		132,132,132,132,132,132,132,132,132,132,132,132,132,132,131,131,131,131,131,131,131,131,131,131,131,131,131,131,130,130,130,130,130,130,130,130,130,130,
		130,130,130,130,130,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,127,127,
		127,127,127,127,127,127,127,127,127,127,127,127,127,126,126,126,126,126,126,126,126,126,126,126,126,126,126,126,126,125,125,125,125,125,125,125,125,125,
		125,125,125,125,125,125,125,124,124,124,124,124,124,124,124,124,124,124,124,124,124,124,124,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,
		123,122,122,122,122,122,122,122,122,122,122,122,122,122,122,122,122,122,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,120,120,120,
		120,120,120,120,120,120,120,120,120,120,120,120,120,120,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,118,118,118,118,118,118,118,
		118,118,118,118,118,118,118,118,118,118,118,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,116,116,116,116,116,116,116,116,116,
		116,116,116,116,116,116,116,116,116,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,114,114,114,114,114,114,114,114,114,114,114,
		114,114,114,114,114,114,114,114,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,112,112,112,112,112,112,112,112,112,112,112,
		112,112,112,112,112,112,112,112,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,110,110,110,110,110,110,110,110,110,110,
		110,110,110,110,110,110,110,110,110,110,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,108,108,108,108,108,108,108,108,
		108,108,108,108,108,108,108,108,108,108,108,108,107,107,107,107,107,107,107,107,107,107,107 */
};



uint16_t get_celcius(uint16_t temperature_reading) {
	uint16_t temp_index = (temperature_reading-TEMP_OFFSET > TEMP_CAP)? TEMP_CAP : temperature_reading - TEMP_OFFSET;
	return temp_lookup_table[temp_index];
}


// ENABLE TEMPERATURE
uint8_t enable_internal_temperature_sensor();
uint8_t enable_external_temperature_sensor_A();
uint8_t enable_external_temperature_sensor_B();


// DISABLE TEMPERATURE
uint8_t disable_internal_temperature_sensor();
uint8_t disable_external_temperature_sensor_A();
uint8_t disable_external_temperature_sensor_B();

// DELETE
uint8_t delete_internal_temperature_sensor();
uint8_t delete_external_temperature_sensor_A();
uint8_t delete_external_temperature_sensor_B();



sensor_ref internal_temperature_sensor;
sensor_ref external_temperature_sensor_A;
sensor_ref external_temperature_sensor_B;

uint8_t fix_temperature(node_ref args) {

	sensor_ref s = node_get_val(args);
	if(!s) return FAILURE;

	int16_t * array = sensor_get_data_array(s);

	uint16_t itor = 0;
	for(itor = 0; itor < sensor_get_size(s); itor++) {
		array[itor] = get_celcius(array[itor]);
	}
	return SUCCESS;
}

void init_temperature_sensor() {
	internal_temperature_sensor = 0;
	external_temperature_sensor_A = 0;
	external_temperature_sensor_B = 0;
}

sensor_ref create_temperature_sensor(uint8_t loc, time_ref period, uint16_t size) {
	sensor_ref * temperature_sensor;
	uint8_t (*delete_func)();
	uint8_t (*enable_func)();
	uint8_t (*disable_func)();
	uint8_t channel;

	if(loc == 'I') {
		temperature_sensor = &internal_temperature_sensor;
		delete_func = &delete_internal_temperature_sensor;
		enable_func = &enable_internal_temperature_sensor;
		disable_func = &disable_internal_temperature_sensor;
		channel = TEMPERATURE_ADC;
	} else if (loc == 'A') {
		temperature_sensor = &external_temperature_sensor_A;
		delete_func = &delete_external_temperature_sensor_A;
		enable_func = &enable_external_temperature_sensor_A;
		disable_func = &disable_external_temperature_sensor_A;
		channel = PORT_A_ADC;
	} else if (loc == 'B') {
		temperature_sensor = &external_temperature_sensor_B;
		delete_func = &delete_external_temperature_sensor_B;
		enable_func = &enable_external_temperature_sensor_B;
		disable_func = &disable_external_temperature_sensor_B;
		channel = PORT_B_ADC;
	} else {
		return FAILURE;
	}

	if(*temperature_sensor) {
		// We already have one there
		if((time_cmp(period, sensor_get_period(*temperature_sensor)) == 0) && size == sensor_get_size(*temperature_sensor)) {
			// If they are the same...do nothing
			return *temperature_sensor;
		} else {
			// They are different, so delete the old one
			delete_func();
		}
	}


	action_ref transmit_action = 0;
	action_ref lookup_temp_action = 0;

	node_ref temperature_node = 0;

	for(;;) {

		*temperature_sensor = new_sensor('T', channel, period, size);
		if(!*temperature_sensor) break;

		// Create the lookup_temp_action
		lookup_temp_action = new_action();
		if(!lookup_temp_action) break;
		action_set_func(lookup_temp_action, &fix_temperature);

		temperature_node = new_node(*temperature_sensor, 0);
		if(!temperature_node) break;
		action_set_args(lookup_temp_action, temperature_node);

		sensor_add_action_on_data_full(*temperature_sensor, lookup_temp_action);




		// Create the transmit action
		transmit_action = new_transmit_action(*temperature_sensor);
		if(!transmit_action) break;
		sensor_add_action_on_data_full(*temperature_sensor, transmit_action);

		sensor_set_delete_func(*temperature_sensor, delete_func);
		sensor_set_enable_func(*temperature_sensor, enable_func);
		sensor_set_disable_func(*temperature_sensor, disable_func);

		return *temperature_sensor;
	}

	delete_func();
	node_delete(&temperature_node);
	action_delete(&lookup_temp_action);
	action_delete(&transmit_action);

	return FAILURE;


}

// ENABLE TEMPERATURE
uint8_t enable_internal_temperature_sensor() {
	return enable_sensor(internal_temperature_sensor);
}
uint8_t enable_external_temperature_sensor_A() {
	return enable_sensor(external_temperature_sensor_A);
}
uint8_t enable_external_temperature_sensor_B() {
	return enable_sensor(external_temperature_sensor_B);
}

// DISABLE TEMPERATURE
uint8_t disable_internal_temperature_sensor() {
	return disable_sensor(internal_temperature_sensor);
}
uint8_t disable_external_temperature_sensor_A() {
	return disable_sensor(external_temperature_sensor_A);
}
uint8_t disable_external_temperature_sensor_B() {
	return disable_sensor(external_temperature_sensor_B);
}

// DELETE
uint8_t delete_internal_temperature_sensor() {
	return sensor_delete(&internal_temperature_sensor);
}
uint8_t delete_external_temperature_sensor_A() {
	return sensor_delete(&external_temperature_sensor_A);
}
uint8_t delete_external_temperature_sensor_B() {
	return sensor_delete(&external_temperature_sensor_B);
}























